# docker-compose.yml — mcpvectordb unified deployment
#
# SELECT ONE MODE — comment out the active block, uncomment the desired one.
# Only one mode may be active at a time (Docker Compose rejects duplicate keys).
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │  MODE A — Local container, loopback-only  [DEFAULT — ACTIVE]               │
# │  Claude Desktop:  { "url": "http://localhost:${MCP_PORT:-8000}/mcp" }      │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │  MODE B — LAN HTTP (no HTTPS)                                               │
# │  Set in .env:  ALLOWED_HOSTS=<your-server-LAN-IP>:*                         │
# │  Claude Desktop:  { "url": "http://<LAN_IP>:${MCP_PORT:-8000}/mcp" }       │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │  MODE C — Tailscale HTTPS (recommended for remote access)                   │
# │  Run once:  tailscale serve --bg https / http://127.0.0.1:8000             │
# │  Set in .env:  ALLOWED_HOSTS=<your-tailscale-hostname>                      │
# │  Claude Desktop:  { "url": "https://<tailscale-hostname>/mcp" }            │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │  MODE D — Native TLS (cert + key required)                                  │
# │  mkdir -p certs && openssl req -x509 -nodes -newkey rsa:2048 \             │
# │    -keyout certs/key.pem -out certs/cert.pem -days 365 -subj '/CN=<host>'  │
# │  Claude Desktop:  { "url": "https://<host>:${MCP_PORT:-8443}/mcp" }        │
# └─────────────────────────────────────────────────────────────────────────────┘

services:
  mcpvectordb:
    image: mcpvectordb:0.1.0
    build:
      context: .
      # Uncomment to build with audio (ffmpeg) and OCR (tesseract) support:
      # args:
      #   MEDIA_FORMATS: "true"
    restart: unless-stopped

    # ── NETWORK — pick ONE (network_mode: host and ports: cannot coexist) ────────

    # MODE A — loopback-only (DEFAULT):
    ports:
      - "127.0.0.1:${MCP_PORT:-8000}:${MCP_PORT:-8000}"

    # MODE B / MODE C — LAN or Tailscale, Linux (comment out MODE A ports above):
    # network_mode: host

    # MODE B / MODE C — LAN or Tailscale, macOS / Windows (comment out MODE A ports):
    # ports:
    #   - "0.0.0.0:${MCP_PORT:-8000}:${MCP_PORT:-8000}"

    # MODE D — Native TLS (comment out MODE A ports above):
    # ports:
    #   - "0.0.0.0:${MCP_PORT:-8443}:${MCP_PORT:-8443}"

    # ─────────────────────────────────────────────────────────────────────────────
    env_file:
      - path: .env
        required: false

    environment:
      MCP_TRANSPORT: streamable-http
      MCP_HOST: "0.0.0.0"
      MCP_PORT: "${MCP_PORT:-8000}"
      LANCEDB_URI: /data/lancedb
      EMBEDDING_MODEL: nomic-ai/nomic-embed-text-v1.5

      # MODES B / C / D — uncomment and set in .env before starting:
      # ALLOWED_HOSTS: "${ALLOWED_HOSTS:-}"

      # MODE D — native TLS — also update MCP_PORT above to 8443 (or preferred port):
      # TLS_ENABLED: "true"
      # TLS_CERT_FILE: "/certs/cert.pem"
      # TLS_KEY_FILE: "/certs/key.pem"

    volumes:
      - lancedb-data:/data/lancedb
      - ${DOCS_DIR:-./docs-inbox}:/data/docs:ro
      # MODE D only — mount your certs directory read-only:
      # - ./certs:/certs:ro

volumes:
  lancedb-data:
